package osrm;

import org.apache.commons.io.IOUtils;
import org.apache.http.HttpResponse;
import org.apache.http.client.HttpClient;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.utils.URIBuilder;
import org.apache.http.impl.client.HttpClients;
import org.json.JSONObject;

import java.net.URI;

public class Match {

    final static String OSRM_SERVER = "http://0.0.0.0:5000";

    HttpClient httpClient;

    public Match() {

        httpClient = HttpClients.createDefault();
    }

    /**
     * Snaps the supplied coordinates to the road network, and returns the most likely route given the points.
     *
     * @param coordinates The string containing comma separated lon/lat. Multiple coordinate pairs are separated by a semicolon.
     * @return A JSON object containing the response code, an array of waypoint objects, and an array of route objects.
     */
    public JSONObject matchPoints(String coordinates) {
        String url = String.format(OSRM_SERVER + "/match/v1/car/%s?geometries=geojson&overview=full", coordinates);
        System.out.println(url);
        return fetchResult(url);
    }

    /**
     * Snaps the supplied coordinates to the road network, and returns the most likely route given the points.
     *
     * @param coordinates The string containing comma separated lon/lat. Multiple coordinate pairs are separated by a semicolon.
     * @param profile     The mode of travel. Valid values are 'car', 'bike' and 'foot'.
     * @return A JSON object containing the response code, an array of waypoint objects, and an array of route objects.
     */
    public JSONObject matchPoints(String coordinates, String profile) {
        String url = String.format(OSRM_SERVER + "/match/v1/%s/%s?geometries=geojson&overview=full", profile, coordinates);
        return fetchResult(url);
    }

    public JSONObject fetchResult(String url) {
        JSONObject result = null;
        try {
            URIBuilder builder = new URIBuilder(url);
            URI uri = builder.build();
            HttpGet request = new HttpGet(uri);
            request.addHeader("accept", "application/json");
            HttpResponse response = httpClient.execute(request);
            result = new JSONObject(IOUtils.toString(response.getEntity().getContent(), "UTF-8"));
        } catch (Exception e) {
            System.out.println(e.getMessage());
        }
        return result;
    }

    public static void main (String[] args) {
        Match osrm_match = new Match();
        String coordinates = "13.43605,52.417229999999996\t13.436279999999998,52.41727\t13.436520000000002,52.4173\t13.436760000000001,52.41734\t13.437000000000001,52.41737\t13.43719,52.41741\t13.437389999999999,52.41744\t13.43762,52.41747\t13.43786,52.41751\t13.438089999999999,52.41755\t13.438089999999999,52.41762\t13.438070000000002,52.417840000000005\t13.437999999999999,52.41809\t13.437999999999999,52.41833\t13.437999999999999,52.41855\t13.437999999999999,52.4188\t13.437999999999999,52.41905\t13.43794,52.4193\t13.437920000000002,52.41955\t13.4379,52.4198\t13.437879999999998,52.42\t13.43786,52.4202\t13.43785,52.420359999999995\t13.437829999999998,52.4206\t13.43781,52.42085\t13.437779999999998,52.4211\t13.43776,52.42135\t13.43774,52.4216\t13.43772,52.421820000000004\t13.437579999999999,52.422059999999995\t13.43745,52.422290000000004\t13.43731,52.42253\t13.437170000000002,52.42276\t13.437000000000001,52.423\t13.4369,52.42323\t13.436760000000001,52.42347\t13.436620000000001,52.4237\t13.436620000000001,52.4237\t13.436420000000002,52.42392\t13.43621,52.42414\t13.43609,52.42427\t13.43591,52.424459999999996\t13.4357,52.42468\t13.43551,52.42488\t13.4355,52.424890000000005\t13.43549,52.425\t13.43545,52.42518\t13.435410000000001,52.42543\t13.43537,52.42568\t13.43532,52.42593\t13.435279999999999,52.42617\t13.43524,52.42642\t13.4352,52.42667\t13.43515,52.42692\t13.43511,52.427170000000004\t13.435070000000001,52.4274\t13.435,52.42757\t13.435,52.42781\t13.435,52.428059999999995\t13.435,52.42807\t13.43494,52.428309999999996\t13.43493,52.42848\t13.434920000000002,52.42869\t13.4349,52.428940000000004\t13.43488,52.429190000000006\t13.43486,52.42944\t13.43485,52.42969\t13.434829999999998,52.429930000000006\t13.434829999999998,52.43018000000001\t13.434829999999998,52.43043\t13.434829999999998,52.43068\t13.434829999999998,52.430930000000004\t13.434829999999998,52.431180000000005\t13.434829999999998,52.431430000000006\t13.434829999999998,52.43168000000001\t13.434829999999998,52.43193\t13.434829999999998,52.43218\t13.434820000000002,52.43241999999999\t13.434820000000002,52.432669999999995\t13.434820000000002,52.432919999999996\t13.434820000000002,52.433130000000006\t13.434820000000002,52.43337\t13.434820000000002,52.43359\t13.434820000000002,52.433840000000004\t13.434820000000002,52.434090000000005\t13.434820000000002,52.43434\t13.434820000000002,52.434580000000004\t13.434820000000002,52.434830000000005\t13.434820000000002,52.435080000000006\t13.434820000000002,52.435190000000006\t13.434820000000002,52.4353\t13.434820000000002,52.43552\t13.43481,52.43577\t13.43481,52.43600000000001\t13.43481,52.43626999999999\t13.43481,52.436519999999994\t13.43481,52.436769999999996\t13.43481,52.437\t13.43481,52.43727\t13.43481,52.43751999999999\t13.43481,52.43776999999999\t13.43481,52.438\t13.43481,52.438269999999996\t13.43481,52.43851\t13.43481,52.438759999999995\t13.43481,52.43899999999999\t13.43481,52.439240000000005\t13.4348,52.439319999999995\t13.4348,52.43942\t13.4348,52.43959\t13.4348,52.439840000000004\t13.4348,52.440090000000005\t13.4348,52.44034\t13.4348,52.440369999999994\t13.43471,52.44061\t13.434629999999999,52.44086\t13.43455,52.4411\t13.434460000000001,52.441340000000004\t13.434379999999999,52.441590000000005\t13.434289999999999,52.44183\t13.43421,52.442080000000004\t13.434120000000002,52.442319999999995\t13.434000000000001,52.44256\t13.434000000000001,52.442780000000006\t13.433879999999998,52.443000000000005\t13.4338,52.44327\t13.433710000000001,52.443509999999996\t13.433629999999999,52.44376\t13.433539999999999,52.443999999999996\t13.43353,52.443999999999996\t13.43346,52.4443\t13.4334,52.44454\t13.43334,52.444790000000005\t13.4333,52.444919999999996\t13.433470000000002,52.44514\t13.433629999999999,52.44537\t13.4338,52.4456\t13.434000000000001,52.44583000000001\t13.434120000000002,52.446059999999996\t13.434289999999999,52.446290000000005\t13.43445,52.44651999999999\t13.434610000000001,52.44675\t13.434779999999998,52.446999999999996\t13.43494,52.44721\t13.43511,52.447430000000004\t13.435270000000001,52.44766\t13.435429999999998,52.44789\t13.4356,52.448119999999996\t13.43576,52.44835\t13.435920000000001,52.44858000000001\t13.436060000000001,52.44876\t13.43621,52.449\t13.43635,52.4492\t13.436470000000002,52.449380000000005\t13.43661,52.449619999999996\t13.436760000000001,52.44985\t13.436910000000001,52.45008000000001\t13.43706,52.450309999999995\t13.43721,52.45055\t13.43735,52.45078\t13.4375,52.451\t13.43765,52.45125\t13.4378,52.451480000000004\t13.43795,52.45171\t13.438089999999999,52.45195\t13.438239999999999,52.452180000000006\t13.43839,52.45241\t13.438529999999998,52.452630000000006\t13.43857,52.452690000000004\t13.438479999999998,52.45292\t13.438379999999999,52.45316999999999\t13.438279999999999,52.45341\t13.438189999999999,52.45365\t13.438089999999999,52.45389\t13.437999999999999,52.454119999999996\t13.4379,52.45437\t13.43781,52.454609999999995\t13.437710000000001,52.45485\t13.437610000000001,52.455090000000006\t13.437510000000001,52.45534\t13.437420000000001,52.455580000000005\t13.437320000000001,52.455819999999996\t13.437289999999999,52.455890000000004\t13.43726,52.456\t13.43716,52.45616999999999\t13.43705,52.45641\t13.43694,52.45665\t13.436829999999999,52.45689\t13.436720000000001,52.45713000000001\t13.43661,52.45737\t13.4365,52.457609999999995\t13.43639,52.45785\t13.436320000000002,52.458\t13.43621,52.45824\t13.4361,52.45848\t13.436,52.45871999999999\t13.4359,52.458909999999996\t13.4358,52.45913\t13.43568,52.45936999999999\t13.435570000000002,52.45961\t13.43546,52.45985\t13.43537,52.46\t13.4353,52.460190000000004\t13.435279999999999,52.46026\t13.435220000000001,52.460469999999994\t13.43516,52.460719999999995\t13.435089999999999,52.461000000000006\t13.435,52.461209999999994\t13.435,52.46128\t13.43493,52.46151999999999\t13.43486,52.461769999999994\t13.43479,52.461999999999996\t13.43475,52.462140000000005\t13.4346,52.46238\t13.434439999999999,52.46261\t13.434289999999999,52.46284\t13.43414,52.463069999999995\t13.434000000000001,52.4633\t13.434000000000001,52.46334\t13.433779999999999,52.46357\t13.43361,52.46379\t13.433520000000001,52.46391\t13.43334,52.46414\t13.43317,52.46436\t13.433,52.46459\t13.432870000000001,52.46475\t13.432939999999999,52.46481\t13.43316,52.465\t13.43341,52.465180000000004\t13.43366,52.46538\t13.43392,52.46556999999999\t13.434170000000002,52.46576999999999\t13.43431,52.465880000000006\t13.434460000000001,52.466\t13.43469,52.46618\t13.43494,52.46638000000001\t13.435189999999999,52.46657\t13.43545,52.46677\t13.4356,52.46689\t13.436,52.46694\t13.43639,52.467\t13.436520000000002,52.467\t13.436879999999999,52.467\t13.43728,52.46709\t13.437679999999999,52.46714\t13.43808,52.46719\t13.43849,52.46723000000001\t13.438889999999999,52.46728\t13.43929,52.467330000000004\t13.439689999999999,52.467380000000006\t13.44009,52.46742\t13.440370000000001,52.467459999999996\t13.440539999999999,52.46748\t13.440879999999998,52.46751\t13.441279999999999,52.46756\t13.441679999999998,52.4676\t13.442079999999999,52.46764\t13.44219,52.467659999999995\t13.442120000000001,52.468\t13.442,52.46832\t13.442,52.468669999999996\t13.4419,52.468999999999994\t13.44183,52.46934\t13.44175,52.46969\t13.441720000000002,52.469809999999995\t13.44164,52.47016\t13.441579999999998,52.47041\t13.441579999999998,52.47043000000001\t13.44181,52.470459999999996\t13.44205,52.470490000000005\t13.44229,52.47051999999999\t13.44253,52.47055\t13.442770000000001,52.470580000000005\t13.443,52.47061\t13.44325,52.47064\t13.443489999999999,52.47067\t13.443729999999999,52.4707\t13.444,52.47071999999999\t13.444220000000001,52.47075\t13.444460000000001,52.470780000000005\t13.4447,52.47081\t13.444939999999999,52.47084\t13.445179999999999,52.47087\t13.44542,52.4709\t13.44564,52.47093\t13.445879999999999,52.471000000000004\t13.446110000000001,52.471000000000004\t13.44633,52.471000000000004\t13.44653,52.47107\t13.44677,52.4711\t13.447000000000001,52.471140000000005\t13.44725,52.471169999999994\t13.44749,52.4712\t13.447729999999998,52.47124\t13.448,52.47127\t13.4482,52.471309999999995\t13.44844,52.471340000000005\t13.448520000000002,52.47135\t13.44876,52.47139\t13.449000000000002,52.471419999999995\t13.44924,52.47146\t13.44948,52.47149\t13.449710000000001,52.47153\t13.45,52.47156\t13.45013,52.47159\t13.450370000000001,52.471619999999994\t13.45045,52.471630000000005\t13.45055,52.47165\t13.45074,52.471740000000004\t13.45094,52.471830000000004\t13.45113,52.47192\t13.451260000000001,52.472\t13.451410000000001,52.4721\t13.45156,52.47221999999999\t13.451720000000002,52.47234\t13.451870000000001,52.47245\t13.452,52.47257\t13.45209,52.472640000000006\t13.452210000000001,52.472719999999995\t13.45235,52.472840000000005\t13.45246,52.472919999999995\t13.45261,52.473\t13.452760000000001,52.47316\t13.452910000000001,52.47326999999999\t13.45306,52.47339\t13.453220000000002,52.47351\t13.453370000000001,52.47363000000001\t13.453520000000001,52.47375\t13.45367,52.473859999999995\t13.45382,52.474\t13.454,52.4741\t13.4541,52.4742\t13.45425,52.474309999999996\t13.4544,52.474430000000005\t13.45454,52.474540000000005\t13.45454,52.474540000000005\t13.45455,52.474619999999994\t13.45457,52.474759999999996\t13.45459,52.474909999999994\t13.45461,52.47506\t13.454620000000002,52.47521\t13.45464,52.475359999999995\t13.45466,52.47551\t13.454679999999998,52.47566\t13.4547,52.475809999999996\t13.454720000000002,52.476000000000006\t13.45474,52.47611\t13.45476,52.476259999999996\t13.454770000000002,52.476409999999994\t13.45478,52.476490000000005";
        coordinates = Utils.parseCoordinate(coordinates);

        JSONObject map_matched = osrm_match.matchPoints(coordinates);

        if (map_matched != null)
            System.out.println(Utils.toPrettyFormat(map_matched));

    }
}
